<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tank Level — Sonic</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Minimal modal styling for history chart - stronger dim so the whole app fades to black behind the modal */
    /* Increased overall modal size: wider and taller while keeping the same internal layout */
    .history-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.88);
      z-index: 1200;
      padding: 32px;
    }
    .history-panel {
      width: 100%;
      max-width: 1200px; /* increased width */
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 12px;
      padding: 20px;
      color: var(--text);
      box-shadow: 0 20px 60px rgba(2,6,23,0.6);
      z-index: 1210;
    }
    .history-actions { display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .history-msg { margin-top:8px; color:var(--muted); font-size:13px; }
    @media (max-width:640px){
      .history-panel { padding:12px; }
    }
  </style>
</head>
<body>
  <!-- LOGIN MODAL (very simple, client-side) -->
  <div id="login-modal" class="login-modal" role="dialog" aria-modal="true" aria-label="Login to Tank Level" style="display:none;">
    <div class="login-panel" role="document">
      <h2 style="margin:0 0 8px 0;">Please sign in</h2>
      <p style="margin:0 0 12px 0;color:var(--muted);font-size:13px;">Enter your credentials to continue.</p>

      <form id="login-form" autocomplete="off" style="display:flex;flex-direction:column;gap:8px;">
        <label style="font-size:13px;color:var(--muted);">Username
          <input id="login-username" name="username" type="text" autocomplete="username" class="graph-title-input" required />
        </label>
        <label style="font-size:13px;color:var(--muted);">Password
          <input id="login-password" name="password" type="password" autocomplete="current-password" class="graph-title-input" required />
        </label>

        <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
          <button type="submit" class="btn" style="min-width:96px;">Sign in</button>
          <button type="button" id="login-cancel" class="history-close" style="background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.04);">Cancel</button>
          <div id="login-error" style="color:#ffdede;margin-left:8px;display:none;font-size:13px;"></div>
        </div>
      </form>
    </div>
  </div>

  <header class="topbar">
    <div class="brand-with-logo">
      <!-- Logo on the left, sized professionally -->
      <div class="header-logo" aria-hidden="true">
        <img src="/static/logo.png" alt="Sonic logo" class="logo-img" />
      </div>

      <div class="brand">
        <h1>Tank Level</h1>
        <p class="subtitle">Real-time tank monitoring</p>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Grid of tank cards -->
    <section id="tanks" class="tanks-grid" aria-live="polite">
      <!-- Cards are generated dynamically by script.js -->
    </section>

    <div id="global-error" class="error" style="display:none;"></div>

    <!-- ADMIN MENU (hidden by default). This includes the form to add/update site locations. -->
    <aside id="admin-menu" class="admin-menu" role="region" aria-hidden="true" style="display:none;">
      <div class="admin-menu-inner">
        <h2>Administrator Menu.</h2>

        <!-- Visitor Tracking button -->
        <div>
          <button id="visitor-tracking-btn" class="btn" type="button">Visitor Tracking</button>
        </div>

        <!-- Show All Devices Map -->
        <div style="margin-top:8px;">
          <button id="open-all-map" class="btn" type="button">Show All Devices Map</button>
        </div>

        <!-- Manage Site / Location form (visible to admins) -->
        <div style="margin-top:14px;">
          <strong style="display:block;margin-bottom:8px;color:var(--muted)">Manage Site / Location</strong>

          <div style="display:flex;flex-direction:column;gap:8px;">
            <select id="admin-device-select" class="graph-title-input" aria-label="Choose device (optional)">
              <option value="">— choose device (optional) —</option>
            </select>

            <input id="admin-terminal-id" class="graph-title-input" placeholder="Terminal ID (or leave blank and pick device)" />
            <input id="admin-site-name" class="graph-title-input" placeholder="Site name (optional)" />
            <input id="admin-location-link" class="graph-title-input" placeholder="Location link (Google Maps URL)" />
            <div style="display:flex;gap:8px;">
              <input id="admin-lat" class="graph-title-input" placeholder="Latitude" />
              <input id="admin-lng" class="graph-title-input" placeholder="Longitude" />
            </div>

            <div style="display:flex;gap:8px;align-items:center;">
              <button id="admin-site-save" class="btn" type="button">Save Site</button>
              <span id="admin-site-msg" style="color:var(--muted);font-size:13px;"></span>
            </div>

            <div style="color:var(--muted);font-size:12px;">
              You can provide Terminal ID directly or pick the device from the dropdown to populate it.
            </div>
          </div>
        </div>
      </div>
    </aside>
<!-- User menu for normal (non-admin) users — hidden by default -->
<div id="user-menu" style="display:none;margin-top:16px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 30px rgba(2,6,23,0.45);" role="region" aria-hidden="true">
  <div style="display:flex;flex-direction:column;gap:8px;">
    <strong style="color:var(--text);font-size:16px">User Menu</strong>
    <div style="color:var(--muted);font-size:13px">Quick access</div>
    <div style="margin-top:6px;">
      <button id="user-open-all-map" class="btn" type="button">Show All Devices Map</button>
    </div>
  </div>
</div>
  </main>

  <footer class="footer">
    <span>Powered by Sonic</span>
  </footer>

  <!-- Chart.js (used by the history modal/chart) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Luxon + adapter so Chart.js uses local timezone via the browser -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

  <!-- Chart.js zoom/pan plugin (wheel zoom) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2/dist/chartjs-plugin-zoom.min.js"></script>

  <!-- jsPDF for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    (function () {
      const USERNAME = 'Alfanar_GasLevel1';
      const PASSWORD = 'GasLevel_Alfanar1';

      // Admin credentials (client-side example)
      const ADMIN_USERNAME = 'Sonic';
      const ADMIN_PASSWORD = 'Sonic@123';

      const modal = document.getElementById('login-modal');
      const form = document.getElementById('login-form');
      const usernameInput = document.getElementById('login-username');
      const passwordInput = document.getElementById('login-password');
      const errorEl = document.getElementById('login-error');
      const cancelBtn = document.getElementById('login-cancel');

      function showModal() {
        modal.style.display = 'flex';
        document.body.classList.add('modal-open');
        setTimeout(() => usernameInput.focus(), 50);
      }

      function hideModal() {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
      }

      // Fire-and-forget logging helper. NEVER send passwords.
      function logAttempt(username, isAdminAttempt, success, note) {
        try {
          const payload = {
            username: String(username || '').trim(),
            isAdminAttempt: !!isAdminAttempt,
            success: !!success,
            note: note ? String(note) : ''
          };
          // Fire and forget; do not await or block UI.
          fetch('/api/login-attempt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).catch(() => { /* ignore logging errors */ });
        } catch (e) { /* ignore */ }
      }

      // Always require login on every page load: show modal immediately
      showModal();

      // Form submit handler
      form.addEventListener('submit', function (ev) {
        ev.preventDefault();
        errorEl.style.display = 'none';
        const u = (usernameInput.value || '').trim();
        const p = (passwordInput.value || '').trim();
        const isAdminAttempt = (u === ADMIN_USERNAME);

        // Admin exact-match check first
        if (u === ADMIN_USERNAME && p === ADMIN_PASSWORD) {
          // Log attempt (admin success)
          logAttempt(u, true, true, 'admin login success');

          try { window._clientAuthenticated = true; } catch (e) { /* ignore */ }
          try { window._clientIsAdmin = true; } catch (e) { /* ignore */ }

          hideModal();

          // dispatch event that the rest of the app can listen to
          try { window.dispatchEvent(new Event('app:login')); } catch (e) { /* ignore */ }

          // If the app exposes a start function, call it immediately
          try { if (typeof window.appStart === 'function') window.appStart(); } catch (e) { /* ignore */ }
          return;
        }

        // simple exact-match check for normal user
        if (u === USERNAME && p === PASSWORD) {
          // Log attempt (normal user success)
          logAttempt(u, false, true, 'user login success');

          try { window._clientAuthenticated = true; } catch (e) { /* ignore */ }
          try { window._clientIsAdmin = false; } catch (e) { /* ignore */ }

          hideModal();

          // dispatch event that the rest of the app can listen to
          try { window.dispatchEvent(new Event('app:login')); } catch (e) { /* ignore */ }

          // If the app exposes a start function, call it immediately
          try { if (typeof window.appStart === 'function') window.appStart(); } catch (e) { /* ignore */ }
          return;
        }

        // wrong credentials - log failure (mark as admin attempt if username matched admin user)
        logAttempt(u, isAdminAttempt, false, 'invalid username/password');

        errorEl.textContent = 'Invalid username or password.';
        errorEl.style.display = 'block';
        passwordInput.value = '';
        passwordInput.focus();
      });

      cancelBtn.addEventListener('click', function () {
        // simply reload the page; since auth isn't persisted, reload will still show the login modal
        try { window._clientAuthenticated = false; } catch (e) { /* ignore */ }
        try { window._clientIsAdmin = false; } catch (e) { /* ignore */ }
        hideModal();
        window.location.reload();
      });

      // Accessibility: pressing Escape when modal visible does nothing (to avoid accidentally bypassing)
      modal.addEventListener('keydown', function (ev) {
        if (ev.key === 'Escape') {
          ev.stopPropagation();
          ev.preventDefault();
        }
      });
    })();
  </script>

  <script src="script.js"></script>
</body>
</html>
