<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tank Level — Sonic</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Minimal modal styling for history chart - stronger dim so the whole app fades to black behind the modal */
    /* Increased overall modal size: wider and taller while keeping the same internal layout */
    .history-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.88);
      z-index: 1200;
      padding: 32px;
    }
    .history-panel {
      width: 100%;
      max-width: 1200px; /* increased width */
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 12px;
      padding: 20px;
      color: var(--text);
      box-shadow: 0 20px 60px rgba(2,6,23,0.6);
      z-index: 1210;
    }
    .history-actions { display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .history-msg { margin-top:8px; color:var(--muted); font-size:13px; }
    @media (max-width:640px){
      .history-panel { padding:12px; }
    }

    /* Small tweaks so the new view modal looks very clean */
    .tank-info-view .history-panel {
      max-width: 920px;
      padding: 22px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(12,16,34,0.98), rgba(10,14,30,0.98));
      border: 1px solid rgba(255,255,255,0.03);
      box-shadow: 0 30px 90px rgba(2,6,23,0.75);
    }
  </style>
</head>
<body>
  <!-- LOGIN MODAL (very simple, client-side) -->
  <div id="login-modal" class="login-modal" role="dialog" aria-modal="true" aria-label="Login to Tank Level" style="display:none;">
    <div class="login-panel" role="document">
      <h2 style="margin:0 0 8px 0;">Please sign in</h2>
      <p style="margin:0 0 12px 0;color:var(--muted);font-size:13px;">Enter your credentials to continue.</p>

      <form id="login-form" autocomplete="off" style="display:flex;flex-direction:column;gap:8px;">
        <label style="font-size:13px;color:var(--muted);">Username
          <input id="login-username" name="username" type="text" autocomplete="username" class="graph-title-input" required />
        </label>
        <label style="font-size:13px;color:var(--muted);">Password
          <input id="login-password" name="password" type="password" autocomplete="current-password" class="graph-title-input" required />
        </label>

        <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
          <button type="submit" class="btn" style="min-width:96px;">Sign in</button>
          <button type="button" id="login-cancel" class="history-close" style="background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.04);">Cancel</button>
          <div id="login-error" style="color:#ffdede;margin-left:8px;display:none;font-size:13px;"></div>
        </div>
      </form>
    </div>
  </div>

  <header class="topbar">
    <div class="brand-with-logo">
      <!-- Logo on the left, sized professionally -->
      <div class="header-logo" aria-hidden="true">
        <img src="/static/logo.png" alt="Sonic logo" class="logo-img" />
      </div>

      <div class="brand">
        <h1>Tank Level</h1>
        <p class="subtitle">Real-time tank monitoring</p>
      </div>

      <!-- View toggle placed to the right of brand/legend area -->
      <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
        <!-- The toggle uses the existing .btn style but is visually muted to fit the header -->
        <button id="toggle-view-btn" class="btn" type="button" aria-pressed="false" title="Toggle list/card view" style="background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.04);">
          <span id="toggle-view-icon" aria-hidden="true">☰</span>
          <span id="toggle-view-label" style="margin-left:8px;">List view</span>
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- LEGEND UI (in-page, inside .container) — using exact card visuals for swatches -->
    <details class="legend-panel" aria-label="Legend">
      <summary>Legend</summary>
      <div class="legend-content">
        <div class="legend-section">
          <div class="legend-title">Gas level indicators</div>
          <div class="legend-grid">
            <div class="legend-item">
              <!-- exact same dot used in cards -->
              <span class="status-dot status-green" aria-hidden="true"></span>
              <span class="legend-label">Normal</span>
            </div>
            <div class="legend-item">
              <span class="status-dot status-orange" aria-hidden="true"></span>
              <span class="legend-label">Low</span>
            </div>
            <div class="legend-item">
              <span class="status-dot status-red" aria-hidden="true"></span>
              <span class="legend-label">High</span>
            </div>
          </div>
        </div>

        <div class="legend-section">
          <div class="legend-title">Battery level indicators</div>
          <div class="legend-grid">
            <div class="legend-item">
              <!-- exact same pill used in cards -->
              <span class="battery-dot status-green" aria-hidden="true"></span>
              <span class="legend-label">Full</span>
            </div>
            <div class="legend-item">
              <span class="battery-dot status-orange" aria-hidden="true"></span>
              <span class="legend-label">Normal</span>
            </div>
            <div class="legend-item">
              <span class="battery-dot status-red" aria-hidden="true"></span>
              <span class="legend-label">Low</span>
            </div>
          </div>
        </div>

        <div class="legend-divider" role="separator" aria-hidden="true"></div>

        <div class="legend-section">
          <div class="legend-title">Icons</div>
          <div class="legend-icons" role="list">
            <div class="legend-icon" role="listitem">
              <!-- history icon -->
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M3 3v18h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path><path d="M7 14v-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 14v-8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path><path d="M17 14v-2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path></svg>
              <span>History</span>
            </div>

            <div class="legend-icon" role="listitem">
              <!-- refresh icon -->
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M21 12a9 9 0 10-2.25 5.625" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path><path d="M21 3v6h-6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path></svg>
              <span>Refresh</span>
            </div>

            <div class="legend-icon" role="listitem">
              <!-- device info icon -->
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M12 2v4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path><rect x="6" y="6" width="12" height="14" rx="2" stroke="currentColor" stroke-width="1.4" fill="none"></rect><path d="M12 11v5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path><circle cx="12" cy="9" r="0.6" fill="currentColor"></circle></svg>
              <span>Device Info</span>
            </div>

            <div class="legend-icon" role="listitem">
              <!-- map icon -->
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M12 2C8.686 2 6 4.686 6 8c0 4.5 6 12 6 12s6-7.5 6-12c0-3.314-2.686-6-6-6z" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="8" r="2.4" fill="currentColor"/></svg>
              <span>Map</span>
            </div>
          </div>
        </div>
      </div>
    </details>

    <!-- Template for tank cards (used by script.js). Includes Battery % and GSM % placeholder -->
    <template id="tank-card-template">
      <article class="tank-card" role="group" aria-label="Tank card">
        <header class="tank-card-header">
          <h3 class="tank-name">Site Name</h3>
          <div class="tank-meta">
            <!-- Battery line (existing apps often show battery percent here) -->
            <div class="battery">
              Battery: <span class="battery-percent">--%</span>
            </div>

            <!-- NEW: GSM RSSI percent (will be updated by script.js) -->
            <div class="gsm" aria-hidden="false">
              GSM: <span class="gsm-percent">--%</span>
            </div>
          </div>
        </header>

        <!-- Main content (level bar / percentage) -->
        <div class="tank-body">
          <div class="level">
            <div class="level-percent">--%</div>
            <!-- visual bar (script.js may populate width) -->
            <div class="level-bar"><div class="level-bar-fill" style="width:0%"></div></div>
          </div>

          <div class="tank-actions">
            <button class="btn view-history">History</button>
          </div>
        </div>

        <footer class="tank-footer" style="font-size:12px;color:var(--muted);">
          <div class="last-updated">Updated: --</div>
        </footer>
      </article>
    </template>

    <!-- Grid of tank cards -->
    <section id="tanks" class="tanks-grid" aria-live="polite">
      <!-- Cards are generated dynamically by script.js -->
    </section>

    <!-- NEW: list view container (hidden by default) -->
    <section id="tanks-list" class="tanks-list" style="display:none;" aria-live="polite" aria-label="Tank list view">
      <!-- populated by script.js when list view active -->
    </section>

    <div id="global-error" class="error" style="display:none;"></div>

    <!-- ADMIN MENU (hidden by default). This includes the form to add/update site locations. -->
    <aside id="admin-menu" class="admin-menu" role="region" aria-hidden="true" style="display:none;">
      <div class="admin-menu-inner">
        <h2>Administrator Menu.</h2>

        <!-- Visitor Tracking button -->
        <div>
          <button id="visitor-tracking-btn" class="btn" type="button">Visitor Tracking</button>
        </div>

        <!-- Show All Devices Map -->
        <div style="margin-top:8px;">
          <button id="open-all-map" class="btn" type="button">Show All Devices Map</button>
        </div>

        <!-- Device Information button (no action yet) -->
        <div style="margin-top:8px;">
          <button id="admin-device-info-btn" class="btn" type="button" title="Device Information">Device Information</button>
        </div>

        <!-- Manage Site / Location form (visible to admins) -->
        <div style="margin-top:14px;">
          <strong style="display:block;margin-bottom:8px;color:var(--muted)">Manage Site / Location</strong>

          <div style="display:flex;flex-direction:column;gap:8px;">
            <select id="admin-device-select" class="graph-title-input" aria-label="Choose device (optional)">
              <option value="">— choose device (optional) —</option>
            </select>

            <input id="admin-terminal-id" class="graph-title-input" placeholder="Terminal ID (or leave blank and pick device)" />
            <input id="admin-site-name" class="graph-title-input" placeholder="Site name (optional)" />
            <input id="admin-location-link" class="graph-title-input" placeholder="Location link (Google Maps URL)" />
            <div style="display:flex;gap:8px;">
              <input id="admin-lat" class="graph-title-input" placeholder="Latitude" />
              <input id="admin-lng" class="graph-title-input" placeholder="Longitude" />
            </div>

            <div style="display:flex;gap:8px;align-items:center;">
              <button id="admin-site-save" class="btn" type="button">Save Site</button>
              <span id="admin-site-msg" style="color:var(--muted);font-size:13px;"></span>
            </div>

            <div style="color:var(--muted);font-size:12px;">
              You can provide Terminal ID directly or pick the device from the dropdown to populate it.
            </div>
          </div>
        </div>
      </div>
    </aside>
<!-- User menu for normal (non-admin) users — hidden by default -->
<div id="user-menu" style="display:none;margin-top:16px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 30px rgba(2,6,23,0.45);" role="region" aria-hidden="true">
  <div style="display:flex;flex-direction:column;gap:8px;">
    <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;">
      <button id="user-open-all-map" class="btn" type="button">Show All Devices Map</button>
      <button id="user-device-info-btn" class="btn" type="button" title="Device Information">Device Information</button>
    </div>
  </div>
</div>
  </main>

  <footer class="footer">
    <span>Powered by SONIC</span>
  </footer>

  <!-- Chart.js (used by the history modal/chart) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Luxon + adapter so Chart.js uses local timezone via the browser -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

  <!-- Chart.js zoom/pan plugin (wheel zoom) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2/dist/chartjs-plugin-zoom.min.js"></script>

  <!-- jsPDF for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    (function () {
      const USERNAME = 'Alfanar_GasLevel1';
      const PASSWORD = 'GasLevel_Alfanar1';

      // Additional normal-equivalent user (same access as USERNAME/PASSWORD)
      const ALT_USERNAME = 'Alfanar_Admin1';
      const ALT_PASSWORD = 'Admin_Alfanar1';

      // Admin credentials (client-side example)
      const ADMIN_USERNAME = 'Sonic';
      const ADMIN_PASSWORD = 'Sonic@123';

      const modal = document.getElementById('login-modal');
      const form = document.getElementById('login-form');
      const usernameInput = document.getElementById('login-username');
      const passwordInput = document.getElementById('login-password');
      const errorEl = document.getElementById('login-error');
      const cancelBtn = document.getElementById('login-cancel');

      function showModal() {
        modal.style.display = 'flex';
        document.body.classList.add('modal-open');
        setTimeout(() => usernameInput.focus(), 50);
      }

      function hideModal() {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
      }

      // Fire-and-forget logging helper. NEVER send passwords.
      function logAttempt(username, isAdminAttempt, success, note) {
        try {
          const payload = {
            username: String(username || '').trim(),
            isAdminAttempt: !!isAdminAttempt,
            success: !!success,
            note: note ? String(note) : ''
          };
          // Fire and forget; do not await or block UI.
          fetch('/api/login-attempt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).catch(() => { /* ignore logging errors */ });
        } catch (e) { /* ignore */ }
      }

      // Always require login on every page load: show modal immediately
      showModal();

      // Form submit handler
      form.addEventListener('submit', function (ev) {
        ev.preventDefault();
        errorEl.style.display = 'none';
        const u = (usernameInput.value || '').trim();
        const p = (passwordInput.value || '').trim();
        const isAdminAttempt = (u === ADMIN_USERNAME);

        // Admin exact-match check first
        if (u === ADMIN_USERNAME && p === ADMIN_PASSWORD) {
          // Log attempt (admin success)
          logAttempt(u, true, true, 'admin login success');

          try { window._clientAuthenticated = true; } catch (e) { /* ignore */ }
          try { window._clientIsAdmin = true; } catch (e) { /* ignore */ }
          try { window._clientUsername = u; } catch (e) { /* ignore */ }

          hideModal();

          // dispatch event that the rest of the app can listen to
          try { window.dispatchEvent(new Event('app:login')); } catch (e) { /* ignore */ }

          // If the app exposes a start function, call it immediately
          try { if (typeof window.appStart === 'function') window.appStart(); } catch (e) { /* ignore */ }
          return;
        }

        // simple exact-match check for normal user (accepts either USERNAME or ALT_USERNAME)
        if ((u === USERNAME && p === PASSWORD) || (u === ALT_USERNAME && p === ALT_PASSWORD)) {
          // Log attempt (normal user success)
          logAttempt(u, false, true, 'user login success');

          try { window._clientAuthenticated = true; } catch (e) { /* ignore */ }
          try { window._clientIsAdmin = false; } catch (e) { /* ignore */ }
          try { window._clientUsername = u; } catch (e) { /* ignore */ }

          hideModal();

          // dispatch event that the rest of the app can listen to
          try { window.dispatchEvent(new Event('app:login')); } catch (e) { /* ignore */ }

          // If the app exposes a start function, call it immediately
          try { if (typeof window.appStart === 'function') window.appStart(); } catch (e) { /* ignore */ }
          return;
        }

        // wrong credentials - log failure (mark as admin attempt if username matched admin user)
        logAttempt(u, isAdminAttempt, false, 'invalid username/password');

        errorEl.textContent = 'Invalid username or password.';
        errorEl.style.display = 'block';
        passwordInput.value = '';
        passwordInput.focus();
      });

      cancelBtn.addEventListener('click', function () {
        // simply reload the page; since auth isn't persisted, reload will still show the login modal
        try { window._clientAuthenticated = false; } catch (e) { /* ignore */ }
        try { window._clientIsAdmin = false; } catch (e) { /* ignore */ }
        try { window._clientUsername = ''; } catch (e) { /* ignore */ }
        hideModal();
        window.location.reload();
      });

      // Accessibility: pressing Escape when modal visible does nothing (to avoid accidentally bypassing)
      modal.addEventListener('keydown', function (ev) {
        if (ev.key === 'Escape') {
          ev.stopPropagation();
          ev.preventDefault();
        }
      });
    })();
  </script>

  <script src="script.js"></script>
</body>
</html>
